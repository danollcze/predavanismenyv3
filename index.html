<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="UTF-8">
  <title>Můj Receptář</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <div class="nav">Receptář AVE JA</div>

  <!-- LEVÝ OBRÁZKOVÝ BANNER -->
  <div class="reklamni-obrazek left"></div>

  <!-- PRAVÝ OBRÁZKOVÝ BANNER -->
  <div class="reklamni-obrazek right"></div>

  <section class="donate-section">
    <h2>Podpořte/Donate provoz</h2>
    <div class="donate-qrs">
      <div>
        <img src="R100.png" alt="QR 100 Kč" class="qr-small">
        <div class="qr-popis">0,1K Kč</div>
      </div>
      <div>
        <img src="R200.png" alt="QR 200 Kč" class="qr-small">
        <div class="qr-popis">0,2K Kč</div>
      </div>
      <div>
        <img src="R300.png" alt="QR 300 Kč" class="qr-small">
        <div class="qr-popis">0,5K Kč</div>
      </div>
      <div>
        <img src="R500.png" alt="QR 500 Kč" class="qr-small">
        <div class="qr-popis">1,0K Kč</div>
      </div>
      <div>
        <img src="R1000.png" alt="QR 1000 Kč" class="qr-small">
        <div class="qr-popis">Volitelné</div>
      </div>
    </div>
    <div class="donate-note">Kliknutím na QR Kód obrázek zvětšite </div>
  </section>

  <!-- MODAL na zvětšený QR kód -->
  <div id="qr-modal" class="qr-modal" style="display:none;">
    <div class="qr-modal-overlay"></div>
    <img id="qr-modal-img" src="" alt="QR kód" class="qr-big">
  </div>

  <main>

    <section class="add-recipe" id="add-recipe-section">
      <form id="recipe-form" autocomplete="off">
        <label for="title">Název/Druh:</label>
        <input type="text" id="title" required placeholder="Název receptu">
        <label for="image">Obrázek (URL):</label>
        <input type="url" id="image" placeholder="https://...">
        <label for="ingredients">Ingredience/Poměr přísad (každá na nový řádek):</label>
        <textarea id="ingredients" rows="4" required placeholder="Mouka&#10;Cukr&#10;Vejce"></textarea>
        <label for="steps">Postup/Úpravy (každý krok na nový řádek):</label>
        <textarea id="steps" rows="4" required placeholder="Krok 1&#10;Krok 2"></textarea>
        <label for="cooking-time">Doba vaření (minuty):</label>
        <input type="number" id="cooking-time" min="1" placeholder="např. 40">
        <label for="portion-count">Počet porcí:</label>
        <input type="number" id="portion-count" min="1" placeholder="např. 4">
        <button type="submit" id="submit-btn">Přidat recept</button>
      </form>
    </section>
     <div id="must-login-msg" style="display:none;text-align:center;color:rgb(48, 204, 0);font-weight:bold;margin-bottom:2rem;">
    </div>

    <section class="filter-recipes">
      <h2>Vyhledávání receptu</h2>
      <label for="filter-name">Název:</label>
      <input type="text" id="filter-name" placeholder="Hledat podle názvu...">
      <label for="filter-ingredient">Ingredience:</label>
      <input type="text" id="filter-ingredient" placeholder="Hledat podle ingredience...">
    </section>

    <section class="recipe-grid" id="recipe-grid">
      <!-- Recepty -->
    </section>

    <section class="pagination">
      <button id="prev-page">Předchozí</button>
      <span id="page-info"></span>
      <button id="next-page">Další</button>
    </section>

    <section class="ads-bottom">
      <div class="ads-grid">
        <img src="reklama 1.png" alt="Reklama 1">
        <img src="reklama 2.png" alt="Reklama 2">
        <img src="reklama 3.png" alt="Reklama 3">
        <img src="reklama 4.png" alt="Reklama 4">
        <img src="reklama 5.png" alt="Reklama 5">
        <img src="reklama 6.png" alt="Reklama 6">
        <img src="reklama 7.png" alt="Reklama 7">
        <img src="reklama 8.png" alt="Reklama 8">
        <img src="reklama 9.png" alt="Reklama 9">
      </div>
    </section>
    <div id="login-register-container" style="max-width:340px;margin:2rem auto;">
      <!-- Login box -->
      <div id="login-box">
        <h2>Přihlášení</h2>
        <input id="login-username" type="text" placeholder="Uživatelské jméno" />
        <input id="login-password" type="password" placeholder="Heslo" />
        <button id="login-btn">Přihlásit</button>
        <div id="login-msg"></div>
        <p>
          Nemáš účet?
          <a href="#" onclick="toggleForm();return false;">Registrovat</a>

        </p>
      </div>
      <!-- Register box -->
      <div id="register-box" style="display:none;">
        <h2>Registrace</h2>
        <input id="register-username" type="text" placeholder="Uživatelské jméno" />
        <input id="register-password" type="password" placeholder="Heslo" />
        <input id="register-key" type="text" placeholder="Registrační klíč" />
        <button id="register-btn">Registrovat</button>
        <div id="register-msg"></div>
        <p>
          Už máš účet?
          <a href="#" onclick="toggleForm();return false;">Přihlásit</a>
        </p>
      </div>
    </div>
    <button id="logout-btn">Odhlásit</button>
  </main>
  <script>

    let filterName = '', filterIngredient = '', editingIndex = null;
    let currentPage = 1;
    const recipesPerPage = 6;

    const getRecipes = async () => {
      const res = await fetch('nacti.php');
      return res.ok ? await res.json() : [];
    };

    const saveRecipes = async (recs) => {
      await fetch('uloz.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(recs)
      });
    };

    function createCard(recipe, idx, isLogged) {
      const article = document.createElement('article');
      article.className = 'recipe-card';

      let btnGroup = '';
      if (isLogged) {
        btnGroup = `
      <button class="edit-btn">Upravit</button>
      <button class="delete-btn">Smazat</button>
    `;
      }

      article.innerHTML = `
    ${recipe.image ? `<img src="${recipe.image}" alt="${recipe.title}">` : ''}
    <div class="recipe-content">
      <h2>${recipe.title}</h2>
      ${recipe.cookingTime ? `<div class="cooking-time"><strong>Doba vaření:</strong> ${recipe.cookingTime} minut</div>` : ''}
      ${recipe.portionCount ? `<div class="portion-count"><strong>Počet porcí:</strong> ${recipe.portionCount}</div>` : ''}
      <div class="ingredients">
        <h3>Ingredience:</h3>
        <ul>${recipe.ingredients.map(i => `<li>${i}</li>`).join('')}</ul>
      </div>
      <div class="steps">
        <h3>Postup:</h3>
        <ol>${recipe.steps.map(s => `<li>${s}</li>`).join('')}</ol>
      </div>
      <div class="button-group">
        ${btnGroup}
      </div>
    </div>
  `;

      // Tlačítka pouze když je uživatel přihlášen!
      if (isLogged) {
        article.querySelector('.edit-btn')?.addEventListener('click', () => {
          document.getElementById('title').value = recipe.title;
          document.getElementById('image').value = recipe.image;
          document.getElementById('cooking-time').value = recipe.cookingTime || '';
          document.getElementById('portion-count').value = recipe.portionCount || '';
          document.getElementById('ingredients').value = recipe.ingredients.join('\n');
          document.getElementById('steps').value = recipe.steps.join('\n');
          editingIndex = idx;
          window.scrollTo({ top: 0, behavior: 'smooth' });
          document.getElementById('submit-btn').textContent = 'Uložit změny';
        });

        article.querySelector('.delete-btn')?.addEventListener('click', () => {
          getRecipes().then(arr => {
            arr.splice(idx, 1);
            saveRecipes(arr).then(() => renderRecipes());
          });
        });
      }

      return article;
    }

    async function renderRecipes() {
      const grid = document.getElementById('recipe-grid');
      if (!grid) return;
      grid.innerHTML = '';

      let arr = await getRecipes();
      if (!Array.isArray(arr)) arr = [];

      if (filterName) arr = arr.filter(r => r.title.toLowerCase().includes(filterName));
      if (filterIngredient) arr = arr.filter(r => r.ingredients.some(i => i.toLowerCase().includes(filterIngredient)));

      // Zjisti přihlášení uživatele
      const isLogged = window.isLoggedIn === true;

      const totalPages = Math.max(1, Math.ceil(arr.length / recipesPerPage));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * recipesPerPage;
      const end = start + recipesPerPage;
      const visibleRecipes = arr.slice(start, end);

      visibleRecipes.forEach((r, i) => grid.appendChild(createCard(r, start + i, isLogged)));
      document.getElementById('page-info').textContent = `Stránka ${currentPage} / ${totalPages}`;
      document.getElementById('prev-page').disabled = currentPage === 1;
      document.getElementById('next-page').disabled = currentPage === totalPages;
    }



    document.getElementById('recipe-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const newRec = {
        title: document.getElementById('title').value.trim(),
        image: document.getElementById('image').value.trim(),
        cookingTime: document.getElementById('cooking-time').value.trim(),
        portionCount: document.getElementById('portion-count').value.trim(),
        ingredients: document.getElementById('ingredients').value.trim().split('\n').filter(x => x),
        steps: document.getElementById('steps').value.trim().split('\n').filter(x => x)
      };
      const arr = await getRecipes();
      if (editingIndex !== null) {
        arr[editingIndex] = newRec;
        editingIndex = null;
      } else {
        arr.push(newRec);
      }
      await saveRecipes(arr);
      e.target.reset();
      document.getElementById('submit-btn').textContent = 'Přidat recept';
      renderRecipes();
    });

    document.getElementById('filter-name')?.addEventListener('input', e => {
      filterName = e.target.value.trim().toLowerCase();
      currentPage = 1;
      renderRecipes();
    });

    document.getElementById('filter-ingredient')?.addEventListener('input', e => {
      filterIngredient = e.target.value.trim().toLowerCase();
      currentPage = 1;
      renderRecipes();
    });

    document.getElementById('prev-page')?.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderRecipes();
      }
    });

    document.getElementById('next-page')?.addEventListener('click', async () => {
      const arr = await getRecipes();
      let filtered = arr;
      if (filterName) filtered = filtered.filter(r => r.title.toLowerCase().includes(filterName));
      if (filterIngredient) filtered = filtered.filter(r => r.ingredients.some(i => i.toLowerCase().includes(filterIngredient)));
      const totalPages = Math.max(1, Math.ceil(filtered.length / recipesPerPage));
      if (currentPage < totalPages) {
        currentPage++;
        renderRecipes();
      }
    });
    document.addEventListener('DOMContentLoaded', () => {
      updateAddRecipeVisibility(false);
      // renderRecipes();   <-- SMAŽ nebo ZAKOMENTUJ tento řádek!
      document.querySelectorAll('.qr-small').forEach(img => {
        img.addEventListener('click', e => {
          document.getElementById('qr-modal-img').src = img.src;
          document.getElementById('qr-modal').style.display = 'flex';
        });
      });
      document.getElementById('qr-modal').addEventListener('click', function (e) {
        if (e.target === this || e.target.classList.contains('qr-modal-overlay')) {
          this.style.display = 'none';
          document.getElementById('qr-modal-img').src = '';
        }
      });
    });
    function updateAddRecipeVisibility(isLogged) {
      const addRecipeSection = document.getElementById('add-recipe-section');
      const mustLoginMsg = document.getElementById('must-login-msg');
      if (isLogged) {
        addRecipeSection.style.display = '';
        mustLoginMsg.style.display = 'none';
      } else {
        addRecipeSection.style.display = 'none';
        mustLoginMsg.style.display = '';
      }
    }
    function toggleForm() {
      document.getElementById('login-box').style.display =
        document.getElementById('login-box').style.display === 'none' ? '' : 'none';
      document.getElementById('register-box').style.display =
        document.getElementById('register-box').style.display === 'none' ? '' : 'none';
      document.getElementById('login-msg').textContent = '';
      document.getElementById('register-msg').textContent = '';
    }

    // Registrace
    document.getElementById('register-btn').onclick = function () {
      const username = document.getElementById('register-username').value.trim();
      const pass1 = document.getElementById('register-password').value.trim();
      const regkey = document.getElementById('register-key').value.trim();

      if (!username || !pass1 || !regkey) {
        document.getElementById('register-msg').textContent = "Vyplň vše!";
        return;
      }
      fetch('register.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(pass1)}&regkey=${encodeURIComponent(regkey)}`
      })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            document.getElementById('register-msg').textContent = "Registrace úspěšná. Můžete se přihlásit.";
          } else {
            document.getElementById('register-msg').textContent = data.msg || "Chyba registrace.";
          }
        });
    };

    // Přihlášení
    document.getElementById('login-btn').onclick = function () {
      const username = document.getElementById('login-username').value.trim();
      const pass = document.getElementById('login-password').value.trim();
      fetch('login.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(pass)}`
      })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            // tady NEdělej window.location.reload()
            // Místo toho znovu ověř přihlášení a překresli
            fetch('check_login.php').then(r => r.json()).then(data => {
              window.isLoggedIn = data.logged;
              if (data.logged) {
                document.getElementById('login-register-container').style.display = 'none';
                document.getElementById('logout-btn').style.display = '';
                updateAddRecipeVisibility(true);
              }
              // Tohle volá renderRecipes() a aktualizuje tlačítka!
              renderRecipes();
            });
          } else {
            document.getElementById('login-msg').textContent = data.msg || "Chyba přihlášení.";
          }
        });
    };

    // Odhlášení
    document.getElementById('logout-btn').onclick = function () {
      fetch('logout.php').then(() => window.location.reload());
    };

    // Kontrola přihlášení
    fetch('check_login.php').then(r => r.json()).then(data => {
      window.isLoggedIn = data.logged;
      if (data.logged) {
        document.getElementById('login-register-container').style.display = 'none';
        document.getElementById('logout-btn').style.display = '';
        updateAddRecipeVisibility(true);
      } else {
        document.getElementById('login-register-container').style.display = '';
        document.getElementById('logout-btn').style.display = 'none';
        updateAddRecipeVisibility(false);
      }
      // VOLÁME až teď
      renderRecipes();
    });
  </script>
</body>

</html>